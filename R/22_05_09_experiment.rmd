---
title: "22_05_09_experiments"
output: html_document
---

```{r, include=FALSE}
knitr::opts_chunk$set(fig.width = 8, fig.height = 8)
library(Rssa)
library(tidyr)
library(dplyr)
library(lattice)
library(rlist)
library(ggplot2)
library(RColorBrewer)
# library(plotrix) # for draw.ellipse()
library(abind)
```

```{r}
# l_known - length of "known" signal
# l_forecast - length of forecast
# l_window - length of window
repeats <- 50

MAX_LEN <- 150



MSE <- function(a, b) mean((a - b)^2)

exp_ <- function(base, len = MAX_LEN) exp(base * (1:len))
cos_ <- function(period, phase = 0, len = 150) cospi(2 * ((1:len) / period + phase))


exps <- lapply(c(0, 0.005, 0.015, 0.025), exp_)
# periods <- c(8, 8.01, 8.02, 8.03, 8.04, 8.05, 8.06)
periods <- c(8, 8.02, 8.03, 8.04, 8.05, 8.06, 8.08, 8.1, 8.2)
coses <- lapply(periods, cos_)
signals <- coses

noises <- list(
    lapply(rep(MAX_LEN, repeats), rnorm),
    lapply(rep(MAX_LEN, repeats), rnorm))

groups <- list(list(1), list(1:2), list(1:3), list(1:4))

```

## Getters
```{r}

get_signal1 <- function(x) signals[[x$signal_id1]][1:(x$l_known + x$l_forecast)]
get_signal2 <- function(x) signals[[x$signal_id2]][1:(x$l_known + x$l_forecast)]
get_noise_add1 <- function(x) (x$noise_norm1 * noises[[1]][[x$noise_id]])[1:(x$l_known + x$l_forecast)]
get_noise_add2 <- function(x) (x$noise_norm2 * noises[[2]][[x$noise_id]])[1:(x$l_known + x$l_forecast)]
get_noise_mult1 <- function(x) (1 + x$noise_norm1 * noises[[1]][[x$noise_id]])[1:(x$l_known + x$l_forecast)]
get_noise_mult2 <- function(x) (1 + x$noise_norm2 * noises[[2]][[x$noise_id]])[1:(x$l_known + x$l_forecast)]
get_norm1 <- function(x) 1 / mean(abs(get_signal1(x)[1:x$l_known]))
get_norm2 <- function(x) x$norm_relative / mean(abs(get_signal2(x)[1:x$l_known]))
get_series_add1 <- function(x) get_signal1(x) * x$norm1 + get_noise_add1(x)
get_series_add2 <- function(x) get_signal2(x) * x$norm2 + get_noise_add2(x)
get_series_mult1 <- function(x) get_signal1(x) * get_noise_mult1(x) * x$norm1
get_series_mult2 <- function(x) get_signal2(x) * get_noise_mult2(x) * x$norm2
get_series1 <- get_series_add1
get_series2 <- get_series_add2

get_ssa_error_reconstruct <- function(x) {
    MSE(get_signal1(x)[1:x$l_known] * x$norm1,
        reconstruct(ssa(get_series1(x)[1:x$l_known], L = x$l_window),
                    groups = groups[[x$group_ssa_id]])$F1)
}
get_ssa_error_forecast <- function(x) {
    MSE(get_signal1(x)[x$l_known + (1:x$l_forecast)] * x$norm1,
        rforecast(ssa(get_series1(x)[1:x$l_known], L = x$l_window),
                  groups = groups[[x$group_ssa_id]], len = x$l_forecast))
}
get_mssa_error_reconstruct <- function(x) {
    MSE(get_signal1(x)[1:x$l_known] * x$norm1,
        reconstruct(ssa(cbind(get_series1(x)[1:x$l_known],
                              get_series2(x)[1:x$l_known]),
                        L = x$l_window, kind = "mssa"),
                    groups = groups[[x$group_mssa_id]])$F1[, 1])
}
get_mssa_error_forecast <- function(x) {
    MSE(get_signal1(x)[x$l_known + (1:x$l_forecast)] * x$norm1,
        rforecast(ssa(cbind(get_series1(x)[1:x$l_known],
                            get_series2(x)[1:x$l_known]),
                      L = x$l_window, kind = "mssa"),
                  groups = groups[[x$group_mssa_id]], len = x$l_forecast)[, 1])
}
get_relative_error_reconstruct <- function(x) {
    (x$ssa_error_reconstruct - x$mssa_error_reconstruct) /
    (x$ssa_error_reconstruct + x$mssa_error_reconstruct)
}
get_relative_error_forecast <- function(x) {
    (x$ssa_error_forecast - x$mssa_error_forecast) /
    (x$ssa_error_forecast + x$mssa_error_forecast)
}
get_errors <- function(df) {
    df$norm1 <- apply(df, 1, get_norm1)
    df$norm2 <- apply(df, 1, get_norm2)
    df$ssa_error_reconstruct <- apply(df, 1, get_ssa_error_reconstruct)
    df$ssa_error_forecast <- apply(df, 1, get_ssa_error_forecast)
    df$mssa_error_reconstruct <- apply(df, 1, get_mssa_error_reconstruct)
    df$mssa_error_forecast <- apply(df, 1, get_mssa_error_forecast)
    df <- df %>%
        select(-noise_id) %>%
        group_by(across(-contains("error"))) %>%
        summarise_all(mean) %>%
        ungroup()
    df$relative_error_reconstruct <- apply(df, 1, get_relative_error_reconstruct)
    df$relative_error_forecast <- apply(df, 1, get_relative_error_forecast)

    return(df)
}
```

```{r}


df <- get_errors(expand.grid(
    signal_id1 = 1,
    signal_id2 = 1:length(signals),
    noise_id = 1:repeats,
    noise_norm1 = c(0.4),
    noise_norm2 = 0.0,
    norm_relative = c(1),
    l_known = 100,
    l_forecast = 20,
    l_window = c(50),
    group_ssa_id = 2,
    group_mssa_id = c(2, 4),
    crutch = list(1)
))

tmp <- max(c(df$ssa_error_reconstruct, df$mssa_error_reconstruct))
ggplot(df) +
    geom_point(aes(x = ssa_error_reconstruct,
                   y = mssa_error_reconstruct),
               alpha = 0.9,
               size = 5) +
    scale_color_brewer(palette = "Spectral") +
    theme_dark() +
    xlim(0, tmp) + ylim(0, tmp)

tmp <- max(c(df$ssa_error_forecast, df$mssa_error_forecast))
ggplot(df) +
    geom_point(aes(x = ssa_error_forecast,
                   y = mssa_error_forecast),
               alpha = 0.5,
               size = 5) +
    scale_color_brewer(palette = "Spectral") +
    theme_dark() +
    xlim(0, tmp) + ylim(0, tmp)

# ggplot(df) +
#     geom_boxplot(aes(x = relative_error_reconstruct,
#                      y = as.factor(norm_relative))) +
#     xlim(-1, 1)
                   
# ggplot(df) +
#     geom_boxplot(aes(x = as.factor(norm_relative),
#                      y = relative_error_forecast)) +
#     ylim(-1, 1)

# ggplot(df) +
#     geom_point(aes(x = relative_error_reconstruct,
#                    y = relative_error_forecast,
#                    color = as.factor(norm_relative)),
#                alpha = 0.5,
#                size = 5) +
#     scale_color_brewer(palette = "Spectral") +
#     theme_dark() +
#     xlim(-1, 1) + ylim(-1, 1)

# ggplot(df) +
#     geom_point(aes(x = relative_error_reconstruct,
#                    y = relative_error_forecast,
#                    color = as.factor(l_window)),
#                alpha = 0.5,
#                size = 5) +
#     scale_color_brewer(palette = "Spectral") +
#     theme_dark() +
#     xlim(-1, 1) + ylim(-1, 1)

# ggplot(df) +
#     geom_point(aes(x = relative_error_forecast,
#                    y = relative_error_reconstruct,
#                    color = (ssa_error_reconstruct)),
#                alpha = 0.5,
#                size = 5) +
#     scale_color_gradientn(colours = c("green", "yellow", "red")) +
#     theme_dark()

# ggplot(df) +
#     geom_point(aes(x = relative_error_reconstruct,
#                    y = relative_error_forecast,
#                    color = as.factor(c("1", "1:2", "1:3", "1:4")[group_mssa_id])),
#                alpha = 0.5,
#                size = 5) +
#     scale_color_manual(values = c("red", "blue")) +
#     theme_dark() +
#     xlim(-1, 1) + ylim(-1, 1)


# periods <- c(8, 8.02, 8.03, 8.04, 8.05, 8.06, 8.08, 8.1, 8.2)
# df <- get_errors(expand.grid(
#     signal_id1 = 1,
#     signal_id2 = 1:length(signals),
#     noise_id = 1:repeats,
#     noise_norm1 = c(0.1),
#     noise_norm2 = 0.1,
#     norm_relative = c(1),
#     l_known = 100,
#     l_forecast = 20,
#     l_window = c(50),
#     group_ssa_id = 2,
#     group_mssa_id = c(2, 4),
#     crutch = list(1)
# ))
ggplot(df) +
    geom_point(aes(x = relative_error_reconstruct,
                   y = relative_error_forecast,
                   color = as.factor(periods[signal_id2]),
                   shape = as.factor(c("1", "1:2", "1:3", "1:4")[group_mssa_id])),
               alpha = 0.5,
               size = 5) +
    scale_color_brewer(palette = "Spectral") +
    theme_dark() +
    xlim(-1, 1) + ylim(-1, 1) +
    labs(title = "relative errors, different periods and mssa group",
    color = "2nd signal period",
    shape = "mssa groups")

ggplot(df) +
    geom_point(aes(x = relative_error_reconstruct,
                   y = relative_error_forecast,
                   color = as.factor(noise_norm1)),
               alpha = 0.5,
               size = 5) +
    scale_color_brewer(palette = "Set1") +
    theme_dark() +
    xlim(-1, 1) + ylim(-1, 1)

```

```{r}
# periods <- c(8, 8.01, 8.02, 8.03, 8.04, 8.05, 8.06)

# df <- get_errors(expand.grid(
#     signal_id1 = 1,
#     signal_id2 = 2:length(signals),
#     noise_id = 1:repeats,
#     noise_norm1 = c(0, 0.1, 0.2, 0.3, 0.4),
#     noise_norm2 = 0.1,
#     norm_relative = c(1),
#     l_known = 100,
#     l_forecast = 20,
#     l_window = c(50),
#     group_ssa_id = 2,
#     group_mssa_id = c(2),
#     crutch = list(1)
# ))

# ggplot(df) +
#     geom_line(aes(x = noise_norm1,
#                   y = ssa_error_forecast)) +
#     geom_line(aes(x = noise_norm1,
#                   y = mssa_error_forecast,
#                   color = as.factor(periods[signal_id2]))) +
#     labs(title = "forecast MSSA vs SSA, different periods and 1st noise",
#     y = "forecast error",
#     color = "2nd signal period")



```
